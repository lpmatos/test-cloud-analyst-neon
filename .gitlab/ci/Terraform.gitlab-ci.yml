variables:
  TF_ROOT: $CI_PROJECT_DIR/iac/terraform

âœ¨ Init:
  extends: .terraform
  stage: ğŸ‰ Prepare
  script:
    - cd $TF_ROOT
    - gitlab-terraform init
  rules:
    - if: '$CI_COMMIT_BRANCH == "load-test"'
      changes:
        - terraform/*.tf
        - terraform/chart/*.yaml
      allow_failure: true

ğŸ’¥ Validate:
  extends: .terraform
  stage: âœ”ï¸ Validate
  script:
    - cd $TF_ROOT
    - gitlab-terraform validate
  rules:
    - if: '$CI_COMMIT_BRANCH == "load-test"'
      changes:
        - terraform/*.tf
        - terraform/chart/*.yaml
      allow_failure: true

ğŸ“‡ Plan:
  extends: .terraform
  stage: ğŸ“¦ Build
  script:
    - cd $TF_ROOT
    - gitlab-terraform plan
    - gitlab-terraform plan-json
  artifacts:
    paths:
      - $TF_ROOT/plan.cache
      - $TF_ROOT/plan.json
    reports:
      terraform: $TF_ROOT/plan.json
  rules:
    - if: '$CI_COMMIT_BRANCH == "load-test"'
      changes:
        - terraform/*.tf
        - terraform/chart/*.yaml
      allow_failure: true

âš¡ Apply:
  extends: .terraform
  stage: ğŸš€ Deploy
  environment:
    name: production
  script:
    - cd $TF_ROOT
    - gitlab-terraform apply
  dependencies:
    - ğŸ“‡ Plan
  rules:
    - if: '$CI_COMMIT_BRANCH == "load-test"'
      changes:
        - terraform/*.tf
        - terraform/chart/*.yaml
      when: manual
      allow_failure: true

ğŸ§ Clean:
  extends: .terraform
  stage: ğŸš¨ Destroy
  environment:
    name: production
  script:
    - cd $TF_ROOT
    - terraform destroy -auto-approve
  dependencies:
    - âš¡ Apply
  rules:
    - if: '$CI_COMMIT_BRANCH == "load-test"'
      changes:
        - terraform/*.tf
        - terraform/chart/*.yaml
      when: manual
      allow_failure: true
